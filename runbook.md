# Runbook — Blue/Green Observability & Alerts

## Overview
This runbook explains the alerts generated by the `alert_watcher` service for the Blue/Green deployment.

### Alert types
1. **Failover detected**
   - Message example: "Failover detected — traffic moved from blue → green"
   - Meaning: Nginx switched the upstream serving requests from one pool to another.
   - Immediate actions:
     1. Check app health of the *primary* container (`app_blue` if blue was primary).
        - `docker logs app_blue --tail 200`
        - `docker exec -it app_blue curl -s http://localhost:8080/healthz`
     2. Inspect Nginx logs for upstream failures:
        - `docker exec -it nginx tail -n 200 /var/log/nginx/error.log`
        - `docker exec -it nginx tail -n 200 /var/log/nginx/access.log`
     3. If primary is unhealthy, leave failover active and investigate (restart container / check recent deploy).
     4. If primary is healthy unexpectedly, check for intermittent errors and monitor.
   - Suppress alerts: set `MAINTENANCE_MODE=true` in `.env` before planned toggles.

2. **High upstream error rate**
   - Message example: "High upstream error rate: 3.50% errors over last 200 requests"
   - Meaning: Over the sliding window, error rate exceeded `ERROR_RATE_THRESHOLD`.
   - Immediate actions:
     1. Identify which upstream is returning 5xx from logs (field `upstream_addr`).
     2. Inspect container logs for the indicated upstream service:
        - `docker logs <container> --tail 200`
     3. If errors are due to deploy/rolling update, consider reverting or removing unhealthy instance from rotation.
     4. If errors persist, consider switching active pool until issue resolved.

3. **Recovery**
   - When traffic returns to the original pool, watcher may post a failover message for the other direction or none if suppressed by cooldown.
   - Confirm normal operation by sampling `/version` endpoint directly and via Nginx.

## Operational Commands
- View Nginx access logs:

docker exec -it nginx tail -n 200 /var/log/nginx/access.log

- View Nginx error logs:

- View Nginx error logs:

- Inspect container logs:
docker logs app_blue --tail 200
docker logs app_green --tail 200
docker logs alert_watcher --tail 200
- Toggle maintenance mode to suppress alerts:
- Edit `.env` set `MAINTENANCE_MODE=true`, then `docker compose restart alert_watcher`
- After maintenance, set `MAINTENANCE_MODE=false` and restart watcher.

## Notes
- Alerts are deduplicated and rate-limited by `ALERT_COOLDOWN_SEC`.
- Slack webhook must be configured in `.env`. Do not commit secrets to the repository.
